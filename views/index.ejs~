<div class="container">
<script>

function message(obj){
   parsed_obj = JSON.parse(obj);
   $("#latestmsg").text(parsed_obj.user + " said: " + parsed_obj.message);
}

var socket = new io.Socket(null, {port: 8134, rememberTransport: false});
socket.connect();
socket.on('message', function(obj){
    message(obj);
});

function subscribeToGeoHash(geohash) {
  socket.send(JSON.stringify({action: "subscribe", geohash: geohash.substring(0,4)}));
}

$(document).ready(function() {
  $("#currentLocation").text("Trying to determine location...");
  // Request a position, no more than 10 minutes old
  navigator.geolocation.getCurrentPosition(successCallback,
                                           errorCallback,
                                           {maximumAge:600000});

  function successCallback(position) {
    // By using the 'maximumAge' option above, the position
    // object is guaranteed to be at most 10 minutes old.
    //$("#currentLocation").text("found location: ("+position.coords.latitude+","+position.coords.longitude+")");
    $("#currentLocation").text("");
    // Convert to GeoHash
    var gh = encodeGeoHash(position.coords.latitude,position.coords.longitude);
    $("#geohash").val(gh);
    // Subscribe to this area
    subscribeToGeoHash(gh);
  }

  function errorCallback(error) {
    // Update a div element with error.message.
    $("#currentLocation").text("Error determining position: "+error);
  }

  $("#messageForm").submit(function(event) {
    event.preventDefault();
    var form = $(this);
    var url = form.attr('action');
    $.post(url, {username: $('#username').val(),
           message: $('#message').val(),
           geohash: $('#geohash').val()});
  });
});
</script>

<div id="currentLocation"></div>

<form id="messageForm" action="/messages" method="post">
  <label for="username">Nickname</label><br />
  <input id="username" type="text" name="username" /> <br />
  <label for="geohash">GeoHash</label><br />
  <input id="geohash" type="text" name="geohash" /> <br />
  <label for="message">Message</label><br />
  <input id="message" type="text" name="message" /> <br />
  <input type="submit" />
</form>
<br />
</div>

<div id="latestmsg">Latest message displayed here...</div>

